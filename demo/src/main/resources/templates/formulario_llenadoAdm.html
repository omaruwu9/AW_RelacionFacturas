<!-- Vista de formulario de llenado con funciones completas -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PROGEN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" th:href="@{/images/favicon.png}"/>
    <style>
        body {background-color: #0f0f0f;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color: #f4f4f4;margin: 0;padding: 0;display: flex;flex-direction: column;min-height: 100vh;}
        header {background-color: #161616;padding: 20px 60px;display: flex;justify-content: space-between;align-items: center;border-bottom: 2px solid #e60012;box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);}
        header img { height: 60px; }
        #botones button {background-color: #e60012;color: white;border: none;padding: 10px 30px;border-radius: 5px;font-size: 15px;font-weight: 600;cursor: pointer;margin-left: 12px;transition: all 0.3s ease;}
        #botones button:hover {background-color: #b3000e;}
        .container { max-width: 1200px; margin: 30px auto; padding: 40px; background-color: #1a1a1a; border-radius: 12px; }
        h2 { color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; }
        form { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        label { font-weight: 600; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #555; background-color: #2c2c2c; color: #f4f4f4; }
        button[type="submit"] { background-color: #e60012; color: white; border: none; padding: 14px; font-weight: bold; border-radius: 6px; cursor: pointer; width: 200px; margin: 0 auto; }
        table {width: 100%; border-collapse: collapse; background-color: #121212; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.4);}
        th, td {padding: 12px 15px; border-bottom: 1px solid #2a2a2a; text-align: left; font-size: 14px;}
        th {background-color: #1f1f1f; color: #ff4c4c; text-transform: uppercase; font-size: 13px;}
        tr:hover {background-color: #262626; cursor: pointer;}
    </style>
</head>
<body>

<header>
    <img src="/images/promex-logo.png" alt="Promex Logo">
    <div id="botones">
        <button onclick="location.href='/volverAdm'">Regresar</button>
        <button onclick="location.href='/logout'">Cerrar Sesión</button>
    </div>
</header>

<div class="container">
    <h2>Llenado Órden de Compra</h2>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
        <tbody>
        <tr>
            <td><strong>Solicitud OC:</strong></td>
            <td><span th:text="${orden.solicitudOc}">-</span></td>
            <td><strong>Fecha Requerida:</strong></td>
            <td><span th:text="${orden.fechaRequerida}">-</span></td>
        </tr>
        <tr>
            <td><strong>Orden de Compra:</strong></td>
            <td><span id="ordenCompraTexto" th:text="${orden.ordenCompra}">-</span></td>
            <td><strong>Descripción:</strong></td>
            <td><span id="ordenCompraDesc" th:text="${orden.descripcionOC}">-</span></td>
        </tr>
        <tr>
            <td><strong>Cuenta Contable:</strong></td>
            <td><span th:text="${orden.cuentaContable}">-</span></td>
            <td><strong>Descripción:</strong></td>
            <td><span th:text="${orden.descCuentaContable}">-</span></td>
        </tr>
        <tr>
            <td><strong>Centro de Costo:</strong></td>
            <td><span th:text="${orden.centroCosto}">-</span></td>
            <td><strong>Proveedor:</strong></td>
            <td><span th:text="${orden.nombreProveedor}">-</span></td>
        </tr>
        <tr>
            <td><strong>Estado:</strong></td>
            <td><span id="estadoTexto" th:text="${orden.estado}">-</span></td>
            <td><strong></strong></td>
            <td><span></span></td>
        </tr>
        </tbody>
    </table>


    <form id="llenadoForm">
        <input type="hidden" id="id" name="id">

        <input type="hidden" id="orden_compra" name="orden_compra">

        <label for="archivo">Cargar archivo (XML/PDF):</label>
        <input type="file" id="archivo" accept=".xml,.pdf" class="full-width">

        <label for="claveProdServ">Clave Producto / Servicio</label>
        <select id="claveProdServ" class="full-width">
            <option value="">Seleccione una opción</option>
        </select>

        <label for="descProducto">Descripción del Producto</label>
        <input type="text" id="descProducto" readonly>

        <label for="factura">Número de Factura</label>
        <input type="text" id="factura" name="factura">

        <label for="fecha">Fecha</label>
        <input type="date" id="fecha" name="fecha">

        <label for="folio_fiscal">Folio Fiscal</label>
        <input type="text" id="folio_fiscal" name="folio_fiscal">

        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" name="cantidad">

        <label for="moneda">Moneda</label>
        <select id="moneda" name="moneda">
            <option value="MXN">MXN</option>
            <option value="USD">USD</option>
        </select>

        <label for="pu">Precio Unitario</label>
        <input type="number" step="0.01" id="pu" name="pu">

        <label for="subtotal">Subtotal</label>
        <input type="number" step="0.01" id="subtotal" name="subtotal">

        <label for="iva_porc">IVA (%)</label>
        <input type="number" id="iva_porc" name="iva_porc">

        <label for="total">Total</label>
        <input type="number" step="0.01" id="total" name="total">

        <label for="tipo_cambio">Tipo de Cambio</label>
        <input type="number" step="0.01" id="tipo_cambio" name="tipo_cambio">

        <label for="pesosTotales">Pesos Totales</label>
        <input type="number" step="0.01" id="pesosTotales" name="pesos_totales">

        <label for="poliza">Póliza Garantía</label>
        <select id="poliza" name="poliza_garantia">
            <option value="YES">YES</option>
            <option value="N/A">N/A</option>
        </select>

        <label for="familia">Familia</label>
        <select id="familia" name="id_familia"></select>

        <label for="responsable">Responsable</label>
        <select id="responsable" name="id_responsable"></select>

        <label for="extPresupuesto">Ext. Presupuesto</label>
        <select id="extPresupuesto" name="id_extpresupuesto"></select>

        <div class="full-width">
            <button type="submit">Guardar</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const conceptosMap = {};

        const estadosMap = {
            "O": "Cancelado",
            "I": "Backorder",
            "R": "Recibida",
            "E": "Tránsito",
            "P": "Por aprobar",
            "A": "Planeada",
            "U": "Cerrada"
        };


        // 🔹 Recuperar ID desde la URL
        const id = window.location.pathname.split("/").pop();
        document.getElementById("id").value = id;

        // Obtener datos existentes del llenado si los hay
        try {
            const res = await fetch(`/api/llenado/${id}`);
            if (res.ok) {
                const datos = await res.json();
                if (datos) {
                    for (const [clave, valor] of Object.entries(datos)) {
                        const input = document.querySelector(`[name="${clave}"]`);
                        if (input) {
                            input.value = valor;
                        }
                    }
                }
            }
        } catch (err) {
            console.error("Error al cargar datos existentes:", err);
        }


        const ordenCompraValor = document.getElementById("ordenCompraTexto")?.textContent?.trim();
        document.getElementById("orden_compra").value = ordenCompraValor || "";

        const estadoSpan = document.getElementById("estadoTexto");
        if (estadoSpan) {
            const estadoOriginal = estadoSpan.textContent.trim();
            estadoSpan.textContent = estadosMap[estadoOriginal] || estadoOriginal;
        }


        // Función para calcular pesos totales
        function calcularPesosTotales() {
            const subtotal = parseFloat(document.getElementById("subtotal").value || 0);
            const moneda = document.getElementById("moneda").value;
            let tipoCambio = parseFloat(document.getElementById("tipo_cambio").value || 1);

            if (moneda === "MXN") {
                tipoCambio = 1.00;
                document.getElementById("tipo_cambio").value = "1.00";
            }

            const pesosTotales = subtotal * tipoCambio;
            document.getElementById("pesosTotales").value = pesosTotales.toFixed(2);
        }

        // Recalcular cuando se cambia moneda o tipo de cambio
        document.getElementById("moneda").addEventListener("change", calcularPesosTotales);
        document.getElementById("tipo_cambio").addEventListener("input", calcularPesosTotales);
        document.getElementById("subtotal").addEventListener("input", calcularPesosTotales);

        // cargar selects
        const selects = [
            { campo: "familia", idKey: "id_familia", textKey: "familia" },
            { campo: "responsable", idKey: "id_responsable", textKey: "responsable" },
            { campo: "extPresupuesto", idKey: "id_extpresupuesto", textKey: "ext_presupuesto" }
        ];

        for (const s of selects) {
            const res = await fetch(`/api/${s.campo}`);
            const data = await res.json();
            const sel = document.getElementById(s.campo);

            // Limpiar opciones existentes
            sel.innerHTML = '<option value="">Seleccione una opción</option>';

            // Añadir las opciones del backend
            data.forEach(opt => {
                const option = document.createElement("option");
                option.value = String(opt[s.idKey]);
                option.textContent = opt[s.textKey];
                sel.appendChild(option);
            });

            // Solo asignar valor si hay datos previamente recuperados
            if (typeof datos !== "undefined" && datos[s.idKey] && datos[s.idKey][s.idKey]) {
                const valorSeleccionado = String(datos[s.idKey][s.idKey]);
                const optionExiste = [...sel.options].some(opt => opt.value === valorSeleccionado);

                if (optionExiste) {
                    sel.value = valorSeleccionado;
                } else {
                    console.warn(`⚠️ No se encontró la opción para ${s.campo} con valor:`, valorSeleccionado);
                }
            }
        }


        document.getElementById("archivo").addEventListener("change", function (e) {
            const archivo = e.target.files[0];
            if (archivo && archivo.name.endsWith(".xml")) {
                const reader = new FileReader();
                reader.onload = function () {
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(reader.result, "application/xml");
                    const nsCfdi = "http://www.sat.gob.mx/cfd/4";
                    const nsTfd = "http://www.sat.gob.mx/TimbreFiscalDigital";

                    const comprobante = xml.getElementsByTagNameNS(nsCfdi, "Comprobante")[0];
                    const timbre = xml.getElementsByTagNameNS(nsTfd, "TimbreFiscalDigital")[0];
                    const conceptos = xml.getElementsByTagNameNS(nsCfdi, "Concepto");

                    // Datos generales
                    if (comprobante) {
                        document.getElementById("factura").value = comprobante.getAttribute("Folio") || "";
                        const fecha = comprobante.getAttribute("Fecha") || "";
                        if (fecha) document.getElementById("fecha").value = fecha.split("T")[0];
                        document.getElementById("subtotal").value = comprobante.getAttribute("SubTotal") || "";
                        document.getElementById("total").value = comprobante.getAttribute("Total") || "";
                        document.getElementById("tipo_cambio").value = comprobante.getAttribute("TipoCambio") || "1.00";
                    }

                    if (timbre) {
                        document.getElementById("folio_fiscal").value = timbre.getAttribute("UUID") || "";
                    }

                    // Cargar conceptos al select
                    const select = document.getElementById("claveProdServ");
                    select.innerHTML = '<option value="">Seleccione una opción</option>';
                    for (let concepto of conceptos) {
                        const clave = concepto.getAttribute("ClaveProdServ");
                        const descripcion = concepto.getAttribute("Descripcion");
                        if (clave && descripcion) {
                            conceptosMap[clave] = {
                                descripcion,
                                cantidad: concepto.getAttribute("Cantidad"),
                                valorUnitario: concepto.getAttribute("ValorUnitario"),
                                importe: concepto.getAttribute("Importe"),
                                traslado: concepto.getElementsByTagNameNS(nsCfdi, "Traslado")[0]
                            };
                            const option = document.createElement("option");
                            option.value = clave;
                            option.textContent = `${clave} - ${descripcion}`;
                            select.appendChild(option);
                        }
                    }
                };
                reader.readAsText(archivo);
            }
        });


        // Evento cuando seleccionas una claveProdServ
        document.getElementById("claveProdServ").addEventListener("change", function () {
            const clave = this.value;
            const concepto = conceptosMap[clave];
            if (concepto) {
                document.getElementById("descProducto").value = concepto.descripcion;
                document.getElementById("cantidad").value = concepto.cantidad || "";
                document.getElementById("pu").value = concepto.valorUnitario || "";
                document.getElementById("subtotal").value = concepto.importe || "";

                // Calcular IVA y Total
                const subtotal = parseFloat(concepto.importe || "0");
                const iva = subtotal * 0.16;
                const total = subtotal + iva;

                document.getElementById("iva_porc").value = 16;
                document.getElementById("total").value = total.toFixed(2);

                // Recalcular pesos totales después de llenar campos
                calcularPesosTotales();
            }
        });

        document.getElementById("llenadoForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const datos = Object.fromEntries(new FormData(e.target));

            // Asegurar que ID y orden_compra estén incluidos
            datos.id = id;
            const ordenCompraTexto = document.getElementById("ordenCompraTexto")?.textContent?.trim();
            datos.orden_compra = ordenCompraTexto || "";

            const res = await fetch("/llenadoG", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            });

            if (res.ok) {
                alert("Registro guardado correctamente");
                window.location.href = "/mod_llenado";
            } else {
                alert("Error al guardar el registro");
            }
        });
    });
</script>


</body>
</html>
